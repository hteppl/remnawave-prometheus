import json
import logging
import yaml
from pathlib import Path
from typing import List, Dict, Any

logger = logging.getLogger(__name__)

COUNTRIES_DICT = {
    "XX": "ðŸ´â€â˜ ï¸ Unknown",
    "AF": "ðŸ‡¦ðŸ‡« Afghanistan",
    "AL": "ðŸ‡¦ðŸ‡± Albania",
    "DZ": "ðŸ‡©ðŸ‡¿ Algeria",
    "AD": "ðŸ‡¦ðŸ‡© Andorra",
    "AO": "ðŸ‡¦ðŸ‡´ Angola",
    "AG": "ðŸ‡¦ðŸ‡¬ Antigua and Barbuda",
    "AR": "ðŸ‡¦ðŸ‡· Argentina",
    "AM": "ðŸ‡¦ðŸ‡² Armenia",
    "AU": "ðŸ‡¦ðŸ‡º Australia",
    "AT": "ðŸ‡¦ðŸ‡¹ Austria",
    "AZ": "ðŸ‡¦ðŸ‡¿ Azerbaijan",
    "BS": "ðŸ‡§ðŸ‡¸ Bahamas",
    "BH": "ðŸ‡§ðŸ‡­ Bahrain",
    "BD": "ðŸ‡§ðŸ‡© Bangladesh",
    "BB": "ðŸ‡§ðŸ‡§ Barbados",
    "BY": "ðŸ‡§ðŸ‡¾ Belarus",
    "BE": "ðŸ‡§ðŸ‡ª Belgium",
    "BZ": "ðŸ‡§ðŸ‡¿ Belize",
    "BJ": "ðŸ‡§ðŸ‡¯ Benin",
    "BT": "ðŸ‡§ðŸ‡¹ Bhutan",
    "BO": "ðŸ‡§ðŸ‡´ Bolivia",
    "BA": "ðŸ‡§ðŸ‡¦ Bosnia and Herzegovina",
    "BW": "ðŸ‡§ðŸ‡¼ Botswana",
    "BR": "ðŸ‡§ðŸ‡· Brazil",
    "BN": "ðŸ‡§ðŸ‡³ Brunei",
    "BG": "ðŸ‡§ðŸ‡¬ Bulgaria",
    "BF": "ðŸ‡§ðŸ‡« Burkina Faso",
    "BI": "ðŸ‡§ðŸ‡® Burundi",
    "KH": "ðŸ‡°ðŸ‡­ Cambodia",
    "CM": "ðŸ‡¨ðŸ‡² Cameroon",
    "CA": "ðŸ‡¨ðŸ‡¦ Canada",
    "CV": "ðŸ‡¨ðŸ‡» Cape Verde",
    "CF": "ðŸ‡¨ðŸ‡« Central African Republic",
    "TD": "ðŸ‡¹ðŸ‡© Chad",
    "CL": "ðŸ‡¨ðŸ‡± Chile",
    "CN": "ðŸ‡¨ðŸ‡³ China",
    "HK": "ðŸ‡­ðŸ‡° Hong Kong",
    "CO": "ðŸ‡¨ðŸ‡´ Colombia",
    "KM": "ðŸ‡°ðŸ‡² Comoros",
    "CG": "ðŸ‡¨ðŸ‡¬ Congo",
    "CR": "ðŸ‡¨ðŸ‡· Costa Rica",
    "HR": "ðŸ‡­ðŸ‡· Croatia",
    "CU": "ðŸ‡¨ðŸ‡º Cuba",
    "CY": "ðŸ‡¨ðŸ‡¾ Cyprus",
    "CZ": "ðŸ‡¨ðŸ‡¿ Czech Republic",
    "DK": "ðŸ‡©ðŸ‡° Denmark",
    "DJ": "ðŸ‡©ðŸ‡¯ Djibouti",
    "DM": "ðŸ‡©ðŸ‡² Dominica",
    "DO": "ðŸ‡©ðŸ‡´ Dominican Republic",
    "EC": "ðŸ‡ªðŸ‡¨ Ecuador",
    "EG": "ðŸ‡ªðŸ‡¬ Egypt",
    "SV": "ðŸ‡¸ðŸ‡» El Salvador",
    "GQ": "ðŸ‡¬ðŸ‡¶ Equatorial Guinea",
    "ER": "ðŸ‡ªðŸ‡· Eritrea",
    "EE": "ðŸ‡ªðŸ‡ª Estonia",
    "ET": "ðŸ‡ªðŸ‡¹ Ethiopia",
    "FJ": "ðŸ‡«ðŸ‡¯ Fiji",
    "FI": "ðŸ‡«ðŸ‡® Finland",
    "FR": "ðŸ‡«ðŸ‡· France",
    "GA": "ðŸ‡¬ðŸ‡¦ Gabon",
    "GM": "ðŸ‡¬ðŸ‡² Gambia",
    "GE": "ðŸ‡¬ðŸ‡ª Georgia",
    "DE": "ðŸ‡©ðŸ‡ª Germany",
    "GH": "ðŸ‡¬ðŸ‡­ Ghana",
    "GR": "ðŸ‡¬ðŸ‡· Greece",
    "GD": "ðŸ‡¬ðŸ‡© Grenada",
    "GT": "ðŸ‡¬ðŸ‡¹ Guatemala",
    "GN": "ðŸ‡¬ðŸ‡³ Guinea",
    "GW": "ðŸ‡¬ðŸ‡¼ Guinea-Bissau",
    "GY": "ðŸ‡¬ðŸ‡¾ Guyana",
    "HT": "ðŸ‡­ðŸ‡¹ Haiti",
    "HN": "ðŸ‡­ðŸ‡³ Honduras",
    "HU": "ðŸ‡­ðŸ‡º Hungary",
    "IS": "ðŸ‡®ðŸ‡¸ Iceland",
    "IN": "ðŸ‡®ðŸ‡³ India",
    "ID": "ðŸ‡®ðŸ‡© Indonesia",
    "IR": "ðŸ‡®ðŸ‡· Iran",
    "IQ": "ðŸ‡®ðŸ‡¶ Iraq",
    "IE": "ðŸ‡®ðŸ‡ª Ireland",
    "IL": "ðŸ‡®ðŸ‡± Israel",
    "IT": "ðŸ‡®ðŸ‡¹ Italy",
    "JM": "ðŸ‡¯ðŸ‡² Jamaica",
    "JP": "ðŸ‡¯ðŸ‡µ Japan",
    "JO": "ðŸ‡¯ðŸ‡´ Jordan",
    "KZ": "ðŸ‡°ðŸ‡¿ Kazakhstan",
    "KE": "ðŸ‡°ðŸ‡ª Kenya",
    "KI": "ðŸ‡°ðŸ‡® Kiribati",
    "KP": "ðŸ‡°ðŸ‡µ North Korea",
    "KR": "ðŸ‡°ðŸ‡· South Korea",
    "KW": "ðŸ‡°ðŸ‡¼ Kuwait",
    "KG": "ðŸ‡°ðŸ‡¬ Kyrgyzstan",
    "LA": "ðŸ‡±ðŸ‡¦ Laos",
    "LV": "ðŸ‡±ðŸ‡» Latvia",
    "LB": "ðŸ‡±ðŸ‡§ Lebanon",
    "LS": "ðŸ‡±ðŸ‡¸ Lesotho",
    "LR": "ðŸ‡±ðŸ‡· Liberia",
    "LY": "ðŸ‡±ðŸ‡¾ Libya",
    "LI": "ðŸ‡±ðŸ‡® Liechtenstein",
    "LT": "ðŸ‡±ðŸ‡¹ Lithuania",
    "LU": "ðŸ‡±ðŸ‡º Luxembourg",
    "MG": "ðŸ‡²ðŸ‡¬ Madagascar",
    "MW": "ðŸ‡²ðŸ‡¼ Malawi",
    "MY": "ðŸ‡²ðŸ‡¾ Malaysia",
    "MV": "ðŸ‡²ðŸ‡» Maldives",
    "ML": "ðŸ‡²ðŸ‡± Mali",
    "MT": "ðŸ‡²ðŸ‡¹ Malta",
    "MH": "ðŸ‡²ðŸ‡­ Marshall Islands",
    "MR": "ðŸ‡²ðŸ‡· Mauritania",
    "MU": "ðŸ‡²ðŸ‡º Mauritius",
    "MX": "ðŸ‡²ðŸ‡½ Mexico",
    "FM": "ðŸ‡«ðŸ‡² Micronesia",
    "MD": "ðŸ‡²ðŸ‡© Moldova",
    "MC": "ðŸ‡²ðŸ‡¨ Monaco",
    "MN": "ðŸ‡²ðŸ‡³ Mongolia",
    "ME": "ðŸ‡²ðŸ‡ª Montenegro",
    "MA": "ðŸ‡²ðŸ‡¦ Morocco",
    "MZ": "ðŸ‡²ðŸ‡¿ Mozambique",
    "MM": "ðŸ‡²ðŸ‡² Myanmar",
    "NA": "ðŸ‡³ðŸ‡¦ Namibia",
    "NR": "ðŸ‡³ðŸ‡· Nauru",
    "NP": "ðŸ‡³ðŸ‡µ Nepal",
    "NL": "ðŸ‡³ðŸ‡± Netherlands",
    "NZ": "ðŸ‡³ðŸ‡¿ New Zealand",
    "NI": "ðŸ‡³ðŸ‡® Nicaragua",
    "NE": "ðŸ‡³ðŸ‡ª Niger",
    "NG": "ðŸ‡³ðŸ‡¬ Nigeria",
    "NO": "ðŸ‡³ðŸ‡´ Norway",
    "OM": "ðŸ‡´ðŸ‡² Oman",
    "PK": "ðŸ‡µðŸ‡° Pakistan",
    "PW": "ðŸ‡µðŸ‡¼ Palau",
    "PA": "ðŸ‡µðŸ‡¦ Panama",
    "PG": "ðŸ‡µðŸ‡¬ Papua New Guinea",
    "PY": "ðŸ‡µðŸ‡¾ Paraguay",
    "PE": "ðŸ‡µðŸ‡ª Peru",
    "PH": "ðŸ‡µðŸ‡­ Philippines",
    "PL": "ðŸ‡µðŸ‡± Poland",
    "PT": "ðŸ‡µðŸ‡¹ Portugal",
    "QA": "ðŸ‡¶ðŸ‡¦ Qatar",
    "RO": "ðŸ‡·ðŸ‡´ Romania",
    "RU": "ðŸ‡·ðŸ‡º Russia",
    "RW": "ðŸ‡·ðŸ‡¼ Rwanda",
    "KN": "ðŸ‡°ðŸ‡³ Saint Kitts and Nevis",
    "LC": "ðŸ‡±ðŸ‡¨ Saint Lucia",
    "VC": "ðŸ‡»ðŸ‡¨ Saint Vincent and the Grenadines",
    "WS": "ðŸ‡¼ðŸ‡¸ Samoa",
    "SM": "ðŸ‡¸ðŸ‡² San Marino",
    "ST": "ðŸ‡¸ðŸ‡¹ Sao Tome and Principe",
    "SA": "ðŸ‡¸ðŸ‡¦ Saudi Arabia",
    "SN": "ðŸ‡¸ðŸ‡³ Senegal",
    "RS": "ðŸ‡·ðŸ‡¸ Serbia",
    "SC": "ðŸ‡¸ðŸ‡¨ Seychelles",
    "SL": "ðŸ‡¸ðŸ‡± Sierra Leone",
    "SG": "ðŸ‡¸ðŸ‡¬ Singapore",
    "SK": "ðŸ‡¸ðŸ‡° Slovakia",
    "SI": "ðŸ‡¸ðŸ‡® Slovenia",
    "SB": "ðŸ‡¸ðŸ‡§ Solomon Islands",
    "SO": "ðŸ‡¸ðŸ‡´ Somalia",
    "ZA": "ðŸ‡¿ðŸ‡¦ South Africa",
    "SS": "ðŸ‡¸ðŸ‡¸ South Sudan",
    "ES": "ðŸ‡ªðŸ‡¸ Spain",
    "LK": "ðŸ‡±ðŸ‡° Sri Lanka",
    "SD": "ðŸ‡¸ðŸ‡© Sudan",
    "SR": "ðŸ‡¸ðŸ‡· Suriname",
    "SE": "ðŸ‡¸ðŸ‡ª Sweden",
    "CH": "ðŸ‡¨ðŸ‡­ Switzerland",
    "SY": "ðŸ‡¸ðŸ‡¾ Syria",
    "TW": "ðŸ‡¹ðŸ‡¼ Taiwan",
    "TJ": "ðŸ‡¹ðŸ‡¯ Tajikistan",
    "TZ": "ðŸ‡¹ðŸ‡¿ Tanzania",
    "TH": "ðŸ‡¹ðŸ‡­ Thailand",
    "TL": "ðŸ‡¹ðŸ‡± Timor-Leste",
    "TG": "ðŸ‡¹ðŸ‡¬ Togo",
    "TO": "ðŸ‡¹ðŸ‡´ Tonga",
    "TT": "ðŸ‡¹ðŸ‡¹ Trinidad and Tobago",
    "TN": "ðŸ‡¹ðŸ‡³ Tunisia",
    "TR": "ðŸ‡¹ðŸ‡· Turkey",
    "TM": "ðŸ‡¹ðŸ‡² Turkmenistan",
    "TV": "ðŸ‡¹ðŸ‡» Tuvalu",
    "UG": "ðŸ‡ºðŸ‡¬ Uganda",
    "UA": "ðŸ‡ºðŸ‡¦ Ukraine",
    "AE": "ðŸ‡¦ðŸ‡ª United Arab Emirates",
    "GB": "ðŸ‡¬ðŸ‡§ United Kingdom",
    "US": "ðŸ‡ºðŸ‡¸ United States",
    "UY": "ðŸ‡ºðŸ‡¾ Uruguay",
    "UZ": "ðŸ‡ºðŸ‡¿ Uzbekistan",
    "VU": "ðŸ‡»ðŸ‡º Vanuatu",
    "VA": "ðŸ‡»ðŸ‡¦ Vatican City",
    "VE": "ðŸ‡»ðŸ‡ª Venezuela",
    "VN": "ðŸ‡»ðŸ‡³ Vietnam",
    "YE": "ðŸ‡¾ðŸ‡ª Yemen",
    "ZM": "ðŸ‡¿ðŸ‡² Zambia",
    "ZW": "ðŸ‡¿ðŸ‡¼ Zimbabwe",
}

def generate_prometheus_targets(nodes: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """Convert targets to Prometheus file_sd_configs format."""
    prometheus_targets = []

    for node in nodes:
        name = node.get('name')
        if name.startswith('-'):
            continue

        address = node.get('address')
        country = node.get('countryCode', 'XX')

        prometheus_targets.append({
            'targets': [f"{address}:{9100}"],
            'labels': node.get('labels', {
                'name': name,
                'location': COUNTRIES_DICT.get(country, country)
            })
        })

    return prometheus_targets


def save_targets(targets: List[Dict[str, Any]], output_path: str):
    """Save the generated targets to a YAML file."""
    output_dir = Path(output_path).parent
    output_dir.mkdir(parents=True, exist_ok=True)

    with open(output_path, 'w') as f:
        yaml.dump(targets, f, default_flow_style=False, sort_keys=False)

    logger.info(f"Generated targets file: {output_path}")
